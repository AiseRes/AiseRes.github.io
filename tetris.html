<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>块！</title>
        <style>
            body {
                background-color: black;
                overflow: hidden;
            }
            h1 {
                z-index: -1;
                font-size: 15vh;
                left: calc(50% + 23.5vh);
                top: 30%;
                color: rgba(227, 227, 227, 0.8);
                text-shadow: 0 0 2vh rgb(116, 150, 159);
                position: absolute;
            }
            .game {
                width: 45vh;
                height: 90vh;
                position: absolute;
                left : calc(50% - 22.5vh);
                Top : 0%;
                transform-origin : 50% 0%;
                background-color: rgb(0, 0, 0);
                box-shadow: 0 0 30vh 5vh rgba(51, 131, 151, 0.2);
                /* border: 5px solid rgb(59, 59, 59); */
                /* overflow: hidden; */
                background-repeat: repeat;
                background-size: 10% 5%;
            
            }
            .block {
                width: 4.5vh;
                height: 4.5vh;
                position: absolute;
                background-image: url("rblk.png");
                background-size: 100% 100%;
            }
            .shadow {
                position: absolute;
                width: 4.5vh;
                height: 4.5vh;
                /* z-index: -1; */
            }
            .particle {
                left: 50%;
                top: 50%;
                width: 0.5vh;
                height: 0.5vh;
                background-color: rgb(255, 255, 255);
                border-radius: 50%;
                position: absolute;
                box-shadow: 0 0 5vh 1vh rgba(255, 255, 255, 0.3);
                 z-index: 100;
            }
            .light {
                left: 50%;
                top: 50%;
                width: 4.5vh;
                height: 13.5vh;
                background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));
                position: absolute;
                /* z-index: -1; */
            }
            .nxt_block {
                width: 4.5vh;
                height: 4.5vh;
                position: absolute;
                background-image: url("rblk.png");
                background-size: 100% 100%;
                /* z-index: -1; */
            }
            .nxt_shadow {
                position: absolute;
                width: 4.5vh;
                height: 4.5vh;
                /* z-index: -1; */
            }
        </style>
    </head>
    <body>
        <div class = "game"></div> 
        <script>
            var map = []; var score = 0;
            var make_new = true;
            var allblocks = [
                [   [0, 0, 0, 0],
                    [0, 1, 1, 0],
                    [0, 1, 1, 0],
                    [0, 0, 0, 0] //O 0
                ],
                [   [0, 1, 0, 0],
                    [0, 1, 0, 0],
                    [0, 1, 0, 0],
                    [0, 1, 0, 0] //I1 1
                ],
                [   [0, 0, 0, 0],
                    [1, 1, 1, 1],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0] //I2 2
                ],
                [   [0, 0, 1, 0],
                    [0, 0, 1, 0],
                    [0, 0, 1, 1],
                    [0, 0, 0, 0] //L1 3
                ],
                [   [0, 0, 0, 1],
                    [0, 1, 1, 1],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0] //L2 4
                ],
                [   [0, 1, 1, 0],
                    [0, 0, 1, 0],
                    [0, 0, 1, 0],
                    [0, 0, 0, 0] //L3 5
                ],
                [   [0, 0, 0, 0],
                    [0, 1, 1, 1],
                    [0, 1, 0, 0],
                    [0, 0, 0, 0] //L4 6
                ],
                [   [0, 0, 1, 0],
                    [0, 0, 1, 0],
                    [0, 1, 1, 0],
                    [0, 0, 0, 0] //J1 7
                ],
                [   [0, 0, 0, 0],
                    [0, 1, 1, 1],
                    [0, 0, 0, 1],
                    [0, 0, 0, 0] //J2 8
                ],
                [   [0, 0, 1, 1],
                    [0, 0, 1, 0],
                    [0, 0, 1, 0],
                    [0, 0, 0, 0] //J3 9
                ],
                [   [0, 1, 0, 0],
                    [0, 1, 1, 1],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0] //J4 10
                ],
                [   [0, 0, 0, 0],
                    [0, 0, 1, 1],
                    [0, 1, 1, 0],
                    [0, 0, 0, 0] //S1 11
                ],
                [   [0, 0, 1, 0],
                    [0, 0, 1, 1],
                    [0, 0, 0, 1],
                    [0, 0, 0, 0] //S2 12
                ],
                [   [0, 0, 0, 0],
                    [0, 1, 1, 0],
                    [0, 0, 1, 1],
                    [0, 0, 0, 0] //Z1 13
                ],
                [   [0, 0, 1, 0],
                    [0, 1, 1, 0],
                    [0, 1, 0, 0],
                    [0, 0, 0, 0] //Z2 14
                ],
                [   [0, 0, 1, 0],
                    [0, 1, 1, 1],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0] //T1 15
                ],
                [   [0, 0, 1, 0],
                    [0, 1, 1, 0],
                    [0, 0, 1, 0],
                    [0, 0, 0, 0] //T1 16
                ],
                [   [0, 0, 0, 0],
                    [0, 1, 1, 1],
                    [0, 0, 1, 0],
                    [0, 0, 0, 0] //T1 17
                ],
                [   [0, 0, 1, 0],
                    [0, 0, 1, 1],
                    [0, 0, 1, 0],
                    [0, 0, 0, 0] //T1 18
                ],
            ];
            var shadow_color = ["227, 89, 134", "65, 203, 0", "74, 170, 255", "240, 108, 0"];
            var now_obj; // 5x5grip, [x, y](左上角), 类型, 颜色
            var now_obj_draw; // 绘制对象
            var sz = 4.5; var feet = 0.5;
            var a_move;
            var dist = 0, dir = 0;
            var window_angle = 0, now_window_angle = 0;
            var markx1, markx2;
            var marky1, marky2;
            var nxt_type = [];
            var nxt_num = 1;
            var nxt_s = 0;
            var lenx = 0, leny = 0;
            var col = ["rblk", "gblk", "bblk", "yblk"];
            var nxt_draw = [];
            var cX = 50; cY = 15;
            var size = 2;

            initnxt_type();
            function  initnxt_type() {
                for (var i = 0; i < nxt_num; ++i) {
                    //[O,I1,I2,L1,L2,L3,L4,J1,J2,J3, J4, S1, S2, Z1, Z2, T1, T2, T3, T4
                    //[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18
                    var list = [[0], [1, 2], [3, 4, 5, 6], [7, 8, 9, 10], [11, 12], [13, 14], [15, 16, 17, 18]];
                    var m = Math.floor(Math.random() * 7);
                    var n = Math.floor(Math.random() * list[m].length);
                    nxt_type[i] = [list[m][n], Math.floor(Math.random() * 4)];
                    nxt_draw[i] = []
                }
                var game = document.querySelector(".game");
                for (var i = 0; i < nxt_num; ++i) {
                    var obj = allblocks[nxt_type[(nxt_s + i) % nxt_num][0]];
                    var ox = 0, oy = 0;
                    for (var x = 0; x < 4; ++x) for (var y = 0; y < 4; ++y) if (obj[x][y]) {
                        ox += x;
                        oy += y;
                    } ox /= 4; oy /= 4;
                    for (var x = 0; x < 4; ++x) for (var y = 0; y < 4; ++y) if (obj[x][y]) {
                        var block = document.createElement("div");
                        var shadow = document.createElement("div");
                        block.className = "nxt_block";
                        block.style.backgroundImage = 'url("' + col[nxt_type[(nxt_s + i) % nxt_num][1]] + ".png" + '")';
                        shadow.className = "nxt_shadow";
                        shadow.style.boxShadow = 0 + "vh " + 0 + "vh 4.5vh rgba(" + shadow_color[nxt_type[(nxt_s + i) % nxt_num][1]] + ", 0.4)";
                        shadow.style.width = block.style.width = size + 'vh';
                        shadow.style.height = block.style.height = size + 'vh';
                        var l = cX + (x - ox) * size;
                        var t = cY + (y - oy) * size + (i - 1) * 4.5 * size;

                        shadow.style.left = block.style.left = l + 'vh';
                        shadow.style.top = block.style.top = t + 'vh';

                        nxt_draw[i].push([block, shadow]);
                        game.appendChild(block);
                        game.appendChild(shadow);
                    }
                }
            };
            for (var i = 0; i < 10; ++i) {
                map[i] = [];
                for (var j = 0; j < 20; ++j)
                    map[i][j] = 0;
            }

            function A_move () {
                if (dist >= feet) {
                    now_obj[1][0] += dir * feet;
                    dist -= feet;
                    var cnt = 0;
                    for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (now_obj[0][i][j]) {
                        var x = now_obj[1][0] + i * sz;
                        var y = now_obj[1][1] + j * sz;
                        now_obj_draw[cnt][0].style.left = now_obj_draw[cnt][1].style.left = x + 'vh';
                        now_obj_draw[cnt][0].style.top = now_obj_draw[cnt][1].style.top = y + 'vh';
                        cnt++;
                    }
                } else {
                    dist = 0;
                    clearInterval(a_move);
                }
            }
            function tail () {
                if (make_new == false || make_new == -1) {
                    markx1 = now_obj[1][0];
                    markx2 += (markx1 - markx2) * 0.15;
                    marky1 = now_obj[1][1];
                    marky2 += (marky1 - marky2) * 0.3;
                    if (Math.abs(markx2 - markx1) <= 0.05) markx2 = markx1
                    if (Math.abs(marky2 - marky1) <= 0.05) marky2 = marky1
                }
            } setInterval(tail, 10);          
            function sleep(time) { return new Promise((resolve) => setTimeout(resolve, time)); }
            function spawn() {
                if (make_new == true) {
                    markx1 = markx2 = 2 * sz;
                    marky1 = marky2 = -2 * sz;
                    
                    now_obj = [[], [2 * sz, -4 * sz], nxt_type[nxt_s][0], nxt_type[nxt_s][1]];
                    now_obj[0] = allblocks[now_obj[2]];

                    var list = [[0], [1, 2], [3, 4, 5, 6], [7, 8, 9, 10], [11, 12], [13, 14], [15, 16, 17, 18]];
                    var m = Math.floor(Math.random() * 7);
                    var n = Math.floor(Math.random() * list[m].length);
                    nxt_type[nxt_s][0] = list[m][n];
                    nxt_type[nxt_s][1] = Math.floor(Math.random() * 4);

                    var game = document.querySelector(".game");
                    now_obj_draw = []; var cnt = 0;
                    for (var i = 0; i < 4; ++i) {
                        for (var j = 0; j < 4; ++j) if (now_obj[0][i][j]) 
                        {
                            var block = document.createElement("div");
                            var shadow = document.createElement("div");
                            block.className = "block";
                            block.style.backgroundImage = 'url("' + col[now_obj[3]] + ".png" + '")';
                            block.style.boxShadow = "0 0 4.5vh rgba(" + shadow_color[now_obj[3]] + ", 0.4)";
                            shadow.className = "shadow";
                            var x = now_obj[1][0] + i * sz;
                            var y = now_obj[1][1] + j * sz;

                            shadow.style.left = block.style.left = x + 'vh';
                            shadow.style.top = block.style.top = y + 'vh';
                            now_obj_draw[cnt++] = [block, shadow];
                            game.appendChild(block);
                            game.appendChild(shadow);
                        }
                    }

                    for (var x = 0; x < 4; ++x) {
                        nxt_draw[nxt_s][x][1].remove();
                        nxt_draw[nxt_s][x][0].remove();
                    } nxt_draw[nxt_s] = [];
                    for (var i = 0; i < nxt_num; ++i) if (i != nxt_s)
                        for (var j = 0; j < 4; ++j) for (var k = 0; k < 2; ++k) {
                            var y = parseFloat(nxt_draw[i][j][k].style.top.substring(0, nxt_draw[i][j][k].style.top.length - 2));
                            nxt_draw[i][j][k].style.top = (y - 4.5 * size) + 'vh';
                        }
                
                    var obj = allblocks[nxt_type[nxt_s][0]];
                    var ox = 0, oy = 0;
                    for (var x = 0; x < 4; ++x) for (var y = 0; y < 4; ++y) if (obj[x][y]) {
                        ox += x;
                        oy += y;
                    } ox /= 4; oy /= 4;
                    for (var x = 0; x < 4; ++x) for (var y = 0; y < 4; ++y) if (obj[x][y]) {
                        var block = document.createElement("div");
                        var shadow = document.createElement("div");
                        block.className = "nxt_block";
                        block.style.backgroundImage = 'url("' + col[nxt_type[nxt_s][1]] + ".png" + '")';
                        shadow.className = "nxt_shadow";
                        shadow.style.boxShadow = 0 + "vh " + 0 + "vh 4.5vh rgba(" + shadow_color[nxt_type[nxt_s][1]] + ", 0.4)";
                        shadow.style.width = block.style.width = size + 'vh';
                        shadow.style.height = block.style.height = size + 'vh';
                        var l = cX + (x - ox) * size;
                        var t = cY + (y - oy) * size + (nxt_num - 2) * 4.5 * size;

                        shadow.style.left = block.style.left = l + 'vh';
                        shadow.style.top = block.style.top = t + 'vh';

                        nxt_draw[nxt_s].push([block, shadow]);
                        game.appendChild(block);
                        game.appendChild(shadow);
                    }
                    nxt_s = (nxt_s + 1) % nxt_num;

                    make_new = false;
                }
            }
            function getnum(s) { return parseFloat(s.substring(0,s - 2)); }
            function check () {
                var falling_objects = [];
                var removing_objects = [];
                for (var i = 0; i < 10; ++i) 
                    if (map[i][0] == 1) {
                        hd = document.createElement("h1");
                        var game = document.querySelector(".game");
                        hd.style.left = "2%";
                        hd.style.opacity = "0.5";
                        hd.style.top = "10%";
                        game.appendChild(hd);
                        hd.textContent = "Game Over!";
                        make_new = -3;
                        return;
                    }
                for (var j = 1; j < 20; ++j) {
                    var flag = true;
                    for (var i = 0; i < 10; ++i)
                        if (map[i][j] == 0) flag = false;
                        if (flag == true) {
                            shakeX();
                            var hd = document.getElementById("Score");
                            if (hd == null) {
                                hd = document.createElement("h1");
                                hd.id = "Score";
                                var game = document.querySelector(".game");
                                game.appendChild(hd);
                            }
                            hd.textContent = ++score;
                            for (var i = 0; i < 10; ++i) {
                                map[i][0] = 0;
                                for (var k = j; k > 0; --k)
                                    map[i][k] = map[i][k - 1];
                            }
                            var blks = document.getElementsByClassName("block");
                            var shdw = document.getElementsByClassName("shadow");
                            for (var k = 0; k < blks.length; ++k) {
                                var y = parseFloat(blks[k].style.top.substring(0,blks[k]. style.top.length - 2));
                                if (y < j * sz) {
                                    blks[k].style.top = (y + 4.5) + 'vh';
                                } else if (y == j * sz) {
                                    var x = parseFloat(blks[k].style.left.substring(0,blks[k]. style.left.length - 2));
                                    var color = blks[k].style.boxShadow.substring(0, blks[k].style.boxShadow.indexOf(')') - 5) + ')';
                                    bomb(x, y, color, 1)
                                    blks[k--].remove();
                                }
                            }
                            for (var k = 0; k < shdw.length; ++k) {
                                var y = parseFloat(shdw[k].style.top.substring(0,shdw[k]. style.top.length - 2));
                                if (y < j * sz) {
                                    shdw[k].style.top = (y + 4.5) + 'vh';
                                } else if (y == j * sz) {
                                    shdw[k--].remove();
                                }
                            }
                            // for (var k = 0; k < shdw.length; ++k) {
                            //     var t = parseFloat(shdw[k].style.top.substring(0,shdw[k]. style.top.length - 2));
                            //     if (t < j * sz) falling_objects.push(shdw[k]);
                            //     else if (t == j * sz) removing_objects.push(shdw[k]);
                            // }
                            // for (var i = 0; i < removing_objects.length; ++i) {
                            //     if (removing_objects[i].className == "block") {
                            //         var x = parseFloat(removing_objects[i].style.left.substring(0,removing_objects[i]. style.left.length - 2));
                            //         var y = parseFloat(removing_objects[i].style.top.substring(0,removing_objects[i]. style.top.length - 2));
                            //         var color = removing_objects[i].style.boxShadow.substring(0, removing_objects[i].style.boxShadow.indexOf(')') - 5) + ')';
                            //         bomb(x, y, color)
                            //     }
                            //     removing_objects[i].remove();
                            // }
                            // for (var i = 0; i < falling_objects.length; ++i) {
                            //     var t = parseFloat(falling_objects[i].style.top.substring(0,falling_objects[i].style.top.length - 2));
                            //     falling_objects[i].style.top = (t + 4.5) + 'vh';
                            // }
                            // var cnt = 0;
                            // var act = setInterval (function() {
                            //     if (cnt >= 4.5) clearInterval(act);
                            //     else {
                            //         cnt += 0.5;
                            //         for (var i = 0; i < falling_objects.length; ++i) {
                            //             var t = parseFloat(falling_objects[i].style.top.substring(0,falling_objects[i].style.top.length - 2));
                            //             falling_objects[i].style.top = (t + 0.5) + 'vh';
                            //         }
                            //     }
                            // }, 10);
                    }
                }
                setTimeout(function () {
                    make_new = -2;
                    for (var i = 0; i < 4; ++i)
                        if (now_obj_draw[i][1])
                            now_obj_draw[i][1].style.boxShadow = "0 0 14.5(" + shadow_color[now_obj[3]] + ", 0.4)";
                    make_new = true;
                }, 100);
            }
            function drop() {
                if (make_new == false && dist == 0) {
                    var obj_moved = [];
                    obj_moved[0] = now_obj[0];
                    obj_moved[1] = now_obj[1].slice();
                    obj_moved[2] = now_obj[2];
                    obj_moved[1][1]+= 0.2 + score / 200;
                    obj_moved[3] = now_obj[3];

                    var flag = false;
                    for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (obj_moved[0][i][j] == 1) {
                        var x = obj_moved[1][0] + i * sz;
                        var y = obj_moved[1][1] + j * sz;
                        if (y > 19 * sz) { flag = true; break } //边界判定
                        else if (map[Math.floor(x / sz)][Math.ceil(y / sz)] == 1) { flag = true; break } //碰撞
                    }
                    
                    if (flag == false) {
                        now_obj = obj_moved;
                        var cnt = 0;
                        for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (now_obj[0][i][j]) {
                            var x = now_obj[1][0] + i * sz;
                            var y = now_obj[1][1] + j * sz;
                            now_obj_draw[cnt][0].style.left = now_obj_draw[cnt][1].style.left = x + 'vh';
                            now_obj_draw[cnt][0].style.top = now_obj_draw[cnt][1].style.top = y + 'vh';
                            cnt++;
                        }
                    }
                    if (flag == true) {
                        now_obj[1][1] = obj_moved[1][1] = Math.round(obj_moved[1][1] / sz) * sz;
                        now_obj[1][0] = obj_moved[1][0] = Math.round(obj_moved[1][0] / sz) * sz;
                        var cnt = 0;
                        for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (now_obj[0][i][j]) {
                            var x = now_obj[1][0] + i * sz;
                            var y = now_obj[1][1] + j * sz;
                            map[Math.floor(x / sz)][Math.floor(y / sz)] = 1;
                            now_obj_draw[cnt][0].style.left = now_obj_draw[cnt][1].style.left = x + 'vh';
                            now_obj_draw[cnt][0].style.top = now_obj_draw[cnt][1].style.top = y + 'vh';
                            cnt++;
                        }
                        make_new = -1;
                        check();
                        return;
                    }    
                }
            }
            function bomb(x, y, color) {
                var particle = [];
                var num = 1;
                for (var i = 0; i < num; ++i) { 
                    particle[i] = [];
                    particle[i][0] = document.createElement("div")
                    particle[i][0].className = "particle";
                    particle[i][0].style.left = (x + Math.random()) + 'vh';
                    particle[i][0].style.top = (y + Math.random()) + 'vh';
                    particle[i][0].style.boxShadow = "0 0 5vh 1vh " + color;
                    particle[i][0].style.backgroundColor = color;
                    particle[i][1] = Math.random() - 0.5;
                    particle[i][2] = Math.random() - 0.5;
                    particle[i][3] = 1;
                    Math.random()
                    var game = document.querySelector(".game");
                    game.appendChild(particle[i][0]);
                }
                var cnt = 0;
                var a = setInterval(function() {
                    for (var i = 0; i < num; ++i) { 
                        var x = parseFloat(particle[i][0].style.left.substring(0, particle[i][0].style.left.length - 2));
                        var y = parseFloat(particle[i][0].style.top.substring(0, particle[i][0].style.top.length - 2));
                        if (y + particle[i][2] > 90 - 1) particle[i][2] *= -1;
                        if (x + particle[i][1] < 0 || x + particle[i][1] > 45) {
                            particle[i][1] *= -1;
                            shakeX;
                        }
                        particle[i][0].style.left = (x + particle[i][1]) + 'vh';
                        particle[i][0].style.top = (y + particle[i][2]) + 'vh';
                        particle[i][0].style.opacity = particle[i][3];
                        particle[i][1] *= 0.99;
                        particle[i][2] *= 0.99;
                        if (particle[i][3] > 0)
                            particle[i][3] -= 0.01;
                        else particle[i][3] = 0;
                    }
                    cnt++;
                    if (cnt == 100) {
                        for (var i = 0; i < num; ++i)
                            particle[i][0].remove();
                        clearInterval(a);
                    }
                }, 10);
                
            }
            function dragdot(x, y, color) {
                var particle = [];
                var num = 1;
                for (var i = 0; i < num; ++i) { 
                    particle[i] = [];
                    particle[i][0] = document.createElement("div")
                    particle[i][0].className = "particle";
                    particle[i][0].style.left = x + 'vh';
                    particle[i][0].style.top = y + 'vh';
                    particle[i][0].style.width = 0.4 + 'vh';
                    particle[i][0].style.height = 0.4 + 'vh';
                    particle[i][0].style.boxShadow = "0 0 5vh 1vh " + color;
                    particle[i][0].style.backgroundColor = color;
                    particle[i][1] = (Math.random() - 0.5) * 0.1;
                    particle[i][2] = - Math.random() * 0.2 - 0.2;
                    particle[i][3] = 1;
                    Math.random()
                    var game = document.querySelector(".game");
                    game.appendChild(particle[i][0]);
                }
                var cnt = 0, max = 30;
                var a = setInterval(function() {
                    for (var i = 0; i < num; ++i) { 
                        var x = parseFloat(particle[i][0].style.left.substring(0, particle[i][0].style.left.length - 2));
                        var y = parseFloat(particle[i][0].style.top.substring(0, particle[i][0].style.top.length - 2));
                        particle[i][0].style.left = (x + particle[i][1]) + 'vh';
                        particle[i][0].style.top = (y + particle[i][2]) + 'vh';
                        particle[i][0].style.opacity = particle[i][3];
                        particle[i][1] *= 0.99;
                        particle[i][2] *= 0.99;
                        if (particle[i][3] > 0)
                            particle[i][3] -= 1 / max;
                        else particle[i][3] = 0;
                    }
                    cnt++;
                    if (cnt == max) {
                        for (var i = 0; i < num; ++i)
                            particle[i][0].remove();
                        clearInterval(a);
                    }
                }, 10);
                
            }
            function draglight(x, y, color) {
                var particle = document.createElement("div")
                particle.className = "light";
                particle.style.left = x + 'vh';
                particle.style.top = y - 9 + 'vh';
                particle.style.background = "linear-gradient(to bottom, rgba(255, 255, 255, 0), " + color + ")";
                var game = document.querySelector(".game");
                game.appendChild(particle);
        
                var cnt = 0; var mx = 50;
                var a = setInterval(function() {
                        particle.style.opacity = (mx- cnt) / mx / 2;
                    cnt++;
                    if (cnt == mx) {
                        particle.remove();
                        clearInterval(a);
                    }
                }, 1);
            }
 
            document.addEventListener("keydown", function movement(e) {
                if (e.keyCode == 82) window.location.reload();
                if (e.keyCode == 40 && make_new == false && dist == 0) { //下箭头
                    while (1) {
                        var obj_moved = [];
                        obj_moved[0] = now_obj[0];
                        obj_moved[1] = now_obj[1].slice();
                        obj_moved[2] = now_obj[2];
                        obj_moved[1][1] += sz;
                        obj_moved[1][1] = Math.ceil(obj_moved[1][1] / sz) * sz;
                        obj_moved[3] = now_obj[3];
                        for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (obj_moved[0][i][j] == 1) {
                            var x = obj_moved[1][0] + i * sz;
                            var y = obj_moved[1][1] + j * sz;
                            if (x < 0 || x > 10 * sz || y > 19.5 * sz || map[Math.floor(x / sz)][Math.floor(y / sz)] == 1) { 
                                for (var ii = 0; ii < 4; ++ii) for (var jj = 0; jj < 4; ++jj) if (now_obj[0][ii][jj] == 1) {
                                        var xx = now_obj[1][0] + ii * sz;
                                        var yy = now_obj[1][1] + jj * sz;
                                        dragdot(xx, yy - 9, "rgb(" + shadow_color[now_obj[3]] + ")");
                                        draglight(xx, yy, "rgb(" + shadow_color[now_obj[3]] + ")");
                                    }
                                shakeY();
                                return;
                            }
                        }
                        now_obj = obj_moved;
                    }
                }
                if (e.keyCode >= 37 && e.keyCode <= 39 && (dist == 0 || e.keyCode == 38) && make_new == false) {
                    var obj_moved = [];
                    obj_moved[0] = now_obj[0];
                    obj_moved[1] = now_obj[1].slice();
                    obj_moved[2] = now_obj[2];
                    obj_moved[3] = now_obj[3]
                        
                    if (e.keyCode == 38) { //上箭头
                                //[O,I1,I2,L1,L2,L3,L4,J1,J2,J3, J4, S1, S2, Z1, Z2, T1, T2, T3, T4
                                //[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18
                        var idx = [0, 2, 1, 6, 3, 4, 5, 10, 7, 8, 9, 12, 11, 14, 13, 18, 15, 16, 17]
                        obj_moved[2] = idx[obj_moved[2]];
                        obj_moved[0] = allblocks[obj_moved[2]];
                    }
                    if (e.keyCode == 37) { //左箭头
                        obj_moved[1][0]-= 4.5;
                    }
                    if (e.keyCode == 39) { //右箭头
                        obj_moved[1][0]+= 4.5
                    }

                    //移动后判定
                    for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (obj_moved[0][i][j] == 1) {
                        var x = obj_moved[1][0] + i * sz + dir * dist;
                        var y = obj_moved[1][1] + j * sz;
                        if (x < 0 || x > 9 * sz || y > 20 * sz || map[Math.round(x / sz)][Math.ceil(y / sz)] == 1) {
                            if (e.keyCode == 37) { window_angle += 0.7; }
                            if (e.keyCode == 39) { window_angle -= 0.7; }
                            return;
                        }  //碰撞
                    }

                    for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (obj_moved[0][i][j] == 1) {
                        var x = obj_moved[1][0] + i * sz + dir * dist;
                        var y = obj_moved[1][1] + j * sz;
                        if (map[Math.round(x / sz)][Math.floor(y / sz)] == 1) {
                            now_obj[1][1] = obj_moved[1][1] = Math.ceil(obj_moved[1][1] / sz) * sz;
                        }
                    }

                    //判定成功
                    //now_obj = obj_moved;
                    if (dist == 0) {
                        if (e.keyCode == 37) { dist = 4.5; dir = -1; a_move = setInterval(A_move, 1); }
                        if (e.keyCode == 39) { dist = 4.5; dir = 1; a_move = setInterval(A_move, 1); }
                    }
                    if (e.keyCode == 38) {
                        now_obj = obj_moved;
                        var cnt = 0;
                        for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (now_obj[0][i][j]) {
                            var x = now_obj[1][0] + i * sz;
                            var y = now_obj[1][1] + j * sz;
                            now_obj_draw[cnt][0].style.left = now_obj_draw[cnt][1].style.left = x + 'vh';
                            now_obj_draw[cnt][0].style.top = now_obj_draw[cnt][1].style.top = y + 'vh';
                            cnt++;
                        }
                    }
                }
            }); 
            
            setInterval(function() {
                if (make_new == false || make_new == -1) {
                    lenx = markx2 - markx1;
                    leny = marky2 - marky1;
                    for (var i = 0; i < 4; ++i)
                        now_obj_draw[i][1].style.boxShadow = lenx + "vh " + leny + "vh 4.5vh rgba(" + shadow_color[now_obj[3]] + ", 0.4)";
                }
            }, 5);
            setInterval(function() {
                var game = document.querySelector(".game");
                now_window_angle += (window_angle - now_window_angle) * 0.2;
                // window_angle = (now_obj[1][0] - 5 * 4.5) * 0.0001;
                window_angle *= 0.97;
                game.style.transform = "rotate(" + now_window_angle + "deg)";
            }, 1);
            setInterval(spawn, 1);
            setInterval(drop, 10);

            function shakeY() {
                var element = document.querySelector(".game");
                let start = performance.now();
                const direction = 1;
                const distance = 2;
                var duration = 100;
                const step = (end) => {
                    if (performance.now() - start < duration) {
                        element.style.transform = `translateY(${direction * distance}px)`;
                        requestAnimationFrame(step);
                    } else {
                    element.style.transform = '';
                    }
                    // 每次抖动方向相反
                    // direction *= -1; 
                };
                requestAnimationFrame(step);
            }
            function shakeX() {
                var element = document.querySelector(".game");
                let start = performance.now();
                const direction = 1;
                const distance = 2;
                var duration = 100;
                const step = (end) => {
                    if (performance.now() - start < duration) {
                        element.style.transform = `translateX(${direction * distance}px)`;
                        requestAnimationFrame(step);
                    } else {
                    element.style.transform = '';
                    }
                    // 每次抖动方向相反
                    // direction *= -1; 
                };
                requestAnimationFrame(step);
            }

            var startX, startY;
            document.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            document.addEventListener('touchend', function(e) {
                var distanceX = e.changedTouches[0].clientX - startX;
                var distanceY = e.changedTouches[0].clientY - startY;

                if (Math.abs(distanceX) > Math.abs(distanceY)) {
                    if (dist == 0 && make_new == false) {
                        var obj_moved = [];
                        obj_moved[0] = now_obj[0];
                        obj_moved[1] = now_obj[1].slice();
                        obj_moved[2] = now_obj[2];
                        obj_moved[3] = now_obj[3]
                        if (distanceX < 0) obj_moved[1][0]-= 4.5;
                        else obj_moved[1][0]+= 4.5
                        for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (obj_moved[0][i][j] == 1) {
                            var x = obj_moved[1][0] + i * sz + dir * dist;
                            var y = obj_moved[1][1] + j * sz;
                            if (x < 0 || x > 9 * sz || y > 20 * sz || map[Math.round(x / sz)][Math.ceil(y / sz)] == 1) {
                                if (distanceX < 0) { window_angle += 0.7; }
                                else  { window_angle -= 0.7; }
                                return;
                            }  //碰撞
                        }

                        for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (obj_moved[0][i][j] == 1) {
                            var x = obj_moved[1][0] + i * sz + dir * dist;
                            var y = obj_moved[1][1] + j * sz;
                            if (map[Math.round(x / sz)][Math.floor(y / sz)] == 1) {
                                now_obj[1][1] = obj_moved[1][1] = Math.ceil(obj_moved[1][1] / sz) * sz;
                            }
                        }
                        //判定成功
                        //now_obj = obj_moved;
                        if (dist == 0) {
                            if (distanceX < 0) { dist = 4.5; dir = -1; a_move = setInterval(A_move, 1); }
                            else { dist = 4.5; dir = 1; a_move = setInterval(A_move, 1); }
                        }
                        return;
                    }
                } else {
                    if (distanceY > 0 && make_new == false && dist == 0) { //下滑动
                        while (1) {
                            var obj_moved = [];
                            obj_moved[0] = now_obj[0];
                            obj_moved[1] = now_obj[1].slice();
                            obj_moved[2] = now_obj[2];
                            obj_moved[1][1] += sz;
                            obj_moved[1][1] = Math.ceil(obj_moved[1][1] / sz) * sz;
                            obj_moved[3] = now_obj[3];
                            for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (obj_moved[0][i][j] == 1) {
                                var x = obj_moved[1][0] + i * sz;
                                var y = obj_moved[1][1] + j * sz;
                                if (x < 0 || x > 10 * sz || y > 19.5 * sz || map[Math.floor(x / sz)][Math.floor(y / sz)] == 1) { 
                                    for (var ii = 0; ii < 4; ++ii) for (var jj = 0; jj < 4; ++jj) if (now_obj[0][ii][jj] == 1) {
                                            var xx = now_obj[1][0] + ii * sz;
                                            var yy = now_obj[1][1] + jj * sz;
                                            dragdot(xx, yy - 9, "rgb(" + shadow_color[now_obj[3]] + ")");
                                            draglight(xx, yy, "rgb(" + shadow_color[now_obj[3]] + ")");
                                        }
                                    shakeY();
                                    return;
                                }
                            }
                            now_obj = obj_moved;
                        }
                    }
                    if (distanceY < 0 && make_new == false) {   //上滑动
                        var obj_moved = [];
                        obj_moved[0] = now_obj[0];
                        obj_moved[1] = now_obj[1].slice();
                        obj_moved[2] = now_obj[2];
                        obj_moved[3] = now_obj[3]
                        var idx = [0, 2, 1, 6, 3, 4, 5, 10, 7, 8, 9, 12, 11, 14, 13, 18, 15, 16, 17]
                        obj_moved[2] = idx[obj_moved[2]];
                        obj_moved[0] = allblocks[obj_moved[2]];
                        for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (obj_moved[0][i][j] == 1) {
                            var x = obj_moved[1][0] + i * sz + dir * dist;
                            var y = obj_moved[1][1] + j * sz;
                            if (x < 0 || x > 9 * sz || y > 20 * sz || map[Math.round(x / sz)][Math.ceil(y / sz)] == 1) {
                                if (e.keyCode == 37) { window_angle += 0.7; }
                                if (e.keyCode == 39) { window_angle -= 0.7; }
                                return;
                            }  //碰撞
                        }
                        for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (obj_moved[0][i][j] == 1) {
                            var x = obj_moved[1][0] + i * sz + dir * dist;
                            var y = obj_moved[1][1] + j * sz;
                            if (map[Math.round(x / sz)][Math.floor(y / sz)] == 1) {
                                now_obj[1][1] = obj_moved[1][1] = Math.ceil(obj_moved[1][1] / sz) * sz;
                            }
                        }
                        now_obj = obj_moved;
                        var cnt = 0;
                        for (var i = 0; i < 4; ++i) for (var j = 0; j < 4; ++j) if (now_obj[0][i][j]) {
                            var x = now_obj[1][0] + i * sz;
                            var y = now_obj[1][1] + j * sz;
                            now_obj_draw[cnt][0].style.left = now_obj_draw[cnt][1].style.left = x + 'vh';
                            now_obj_draw[cnt][0].style.top = now_obj_draw[cnt][1].style.top = y + 'vh';
                            cnt++;
                        }
                    }
                }                                                                                                                                                                          
            });


</script>
    </body>
</html>